-- ===============================================================================
-- Скрипт: data_quality.sql
-- Автор:  Бобылева Варвара
-- Группа: БД-251м
-- Назначение: Проверка качества данных для лабораторной работы 1.2
-- Описание: Создание проверок на качество данных для схемы dw
-- ===============================================================================

-- --------------------------------------------------------
-- СЕКЦИЯ 1: ПОЛНОТА (COMPLETENESS)
-- --------------------------------------------------------
--Проверка на наличие пустых или отсутствующих значений в важных полях.

--Эта команда проверит, сколько записей о продажах не имеют идентификатора клиента.
SELECT COUNT(*) FROM dw.sales_fact WHERE cust_id IS NULL;

--Эта команда выявит строки, где важны поля (например, название продукта) не заполнены.
SELECT COUNT(*) FROM dw.product_dim WHERE product_name IS NULL OR product_name = '';

-- --------------------------------------------------------
-- СЕКЦИЯ 2: ТОЧНОСТЬ (ACCURACY)
-- --------------------------------------------------------
--Проверка на соответствие данных реальному миру или заданным правилам.

-- Проверка корректности значений прибыли.
SELECT COUNT(*) FROM dw.sales_fact WHERE profit > sales;

-- Проверка корректности значений скидок.
SELECT COUNT(*) FROM dw.sales_fact WHERE discount < 0 OR discount > 1;

-- --------------------------------------------------------
-- СЕКЦИЯ 3: НЕПРОТИВОРЕЧИВОСТЬ (CONSISTENSY)
-- --------------------------------------------------------
--Проверка на отсутствие противоречий внутри одной записи или между связанными данными.

-- Проверка на логическую последовательность дат.
SELECT COUNT(*) FROM dw.sales_fact WHERE ship_date_id < order_date_id;

-- Проверка целостности данных по одному ключу.
SELECT COUNT(*) FROM dw.geo_dim gd WHERE NOT EXISTS (SELECT 1 FROM dw.sales_fact sf WHERE sf.geo_id = gd.geo_id);

-- --------------------------------------------------------
-- СЕКЦИЯ 4: УНИКАЛЬНОСТЬ (UNIQUENESS)
-- --------------------------------------------------------
--Проверка на отсутствие дублирующихся записей.

-- Проверка на дубликаты в таблице измерений клиентов.
SELECT customer_id, COUNT(*)
FROM dw.customer_dim
GROUP BY customer_id
HAVING COUNT(*) > 1;

-- Проверка на дубликаты в таблице фактов продаж.
SELECT sales_id, COUNT(*)
FROM dw.sales_fact
GROUP BY sales_id
HAVING COUNT(*) > 1;

-- --------------------------------------------------------
-- СЕКЦИЯ 5: ЦЕЛОСТНОСТЬ (INTEGRITY)
-- --------------------------------------------------------
--Проверка на соблюдение связей между таблицами.

-- Проверка ссылки на несуществующие продукты.
SELECT COUNT(*) FROM dw.sales_fact sf
LEFT JOIN dw.product_dim pd ON sf.prod_id = pd.prod_id
WHERE pd.prod_id IS NULL;

-- Проверка ссылок на несуществующих клиентов.
SELECT COUNT(*) FROM dw.sales_fact sf
LEFT JOIN dw.customer_dim cd ON sf.cust_id = cd.cust_id
WHERE cd.cust_id IS NULL;

-- --------------------------------------------------------
-- СЕКЦИЯ 6: АКТУАЛЬНОСТЬ (TIMELINESS)
-- --------------------------------------------------------
--Проверка на своевременность и актуальность данных.

-- Возраст самых старых данных.
-- Цель: Убедиться, что данные не устарели за пределами допустимого диапазона (например, слишком старые).
SELECT MIN(date) AS oldest_date FROM dw.calendar_dim;

-- Возраст самых новых данных.
-- Цель: Проверить, что данные регулярно обновляются, например, вчерашним днем или сегодняшним.
SELECT MAX(date) AS most_recent_date FROM dw.calendar_dim;